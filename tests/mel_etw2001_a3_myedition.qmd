---
title: "mel_etw2001_a3_myedition"
format: pdf
editor: visual
params:
  path_office: "MRTSSM45321USN.csv"        # Office/stationery monthly sales
  path_elect:  "MRTSSM443USS.csv"          # Electronics/appliance monthly sales
  path_nonstore: "RSNSR.csv"               # Nonstore retailers monthly sales (e-comm proxy)
  path_odp: "odp_financials_all_tidy_2022_2025.csv"   # ODP consolidated tidy
  path_bby: "data/bby/bby_financials_all_tidy_2022_2025.csv"# BBY consolidated tidy
---

# Libraries

```{r}
# Libraries
suppressPackageStartupMessages({
  library(readr); library(dplyr); library(tidyr); library(stringr)
  library(lubridate); library(ggplot2); library(scales)
  library(purrr)
})
```

# Helper: ensure file exists, otherwise give a friendly stop() with next steps

```{r}

# Helper: ensure file exists, otherwise give a friendly stop() with next steps
need_file <- function(path, label) {
  if (!file.exists(path)) {
    stop(paste0("Missing file: '", path, "' for ", label, 
                ".\nPlease upload it or update params$... to the correct location."), call. = FALSE)
  }
  normalizePath(path, mustWork = TRUE)
}

# Resolve paths from params
path_office   <- params$path_office
path_elect    <- params$path_elect
path_nonstore <- params$path_nonstore
path_odp      <- params$path_odp
path_bby      <- params$path_bby

# Validate existence where required by the analysis
invisible(lapply(list(
  list(path_office, "Office & Stationery Sales (MRTSSM45321USN)"),
  list(path_elect, "Electronics & Appliance Sales (MRTSSM443USS)"),
  list(path_nonstore, "Nonstore Retailers (RSNSR)"),
  list(path_odp, "ODP consolidated financials tidy"),
  list(path_bby, "BBY consolidated financials tidy")
), function(x) {
  # Only validate if param is non-empty
  if (!is.null(x[[1]]) && nchar(x[[1]]) > 0) need_file(x[[1]], x[[2]])
}))

# Ensure output directory for any exports
if (!dir.exists("output")) dir.create("output", recursive = TRUE)

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 5)
```

```{r}
#| label: setup
need <- c("readr","dplyr","tidyr","lubridate","ggplot2","scales","stringr","broom")
to_install <- setdiff(need, rownames(installed.packages()))
if (length(to_install)) install.packages(to_install, dependencies = TRUE)
invisible(lapply(need, library, character.only = TRUE))

theme_set(theme_minimal(base_size = 12))
lab_short <- function() scales::label_number(scale_cut = scales::cut_short_scale())
lab_pct   <- function() scales::label_percent(accuracy = 0.1)
```

# 1. Executive Summary

**Internal Factor (Melissa):** ODP remains concentrated in **traditional office supplies** with limited **product/service innovation** (e.g., tech accessories, hybrid-work bundles, service subscriptions).

**Key variables (Quarterly, 2022–2024):** - **Office_Sales** — legacy category (FRED `MRTSSM45321USN`) - **Electronics_Sales** — innovation category (FRED `MRTSSM443USS`) - **Nonstore_Sales** — innovation channel (FRED `RSNSR`, e-commerce proxy) - **Office_YoY, Elect_YoY, Nonstore_YoY** — YoY % changes - **Innovation_Composite_YoY** — mean(Elect_YoY, Nonstore_YoY) - **ODP**: Revenue, Rev_YoY, Gross Margin (%) - **BBY**: Revenue, Rev_YoY, Gross Margin (%) — innovator peer

**Findings:** - **Legacy category stagnates**: Office_Sales YoY flat/negative. - **Innovation demand outperforms**: Electronics & Nonstore (e-comm) grow faster. - **BBY outperforms ODP** on YoY revenue and margins, consistent with tech + services innovation. - **ODP under-indexes to innovation**; its Rev_YoY aligns better with innovation proxies than with legacy office supplies. - A modest **innovation mix-shift** implies measurable **Rev YoY uplift** for ODP.

# 2. Paths & Focus Window

```{r}
# FRED industry CSVs (put in same folder)
path_office <- params$path_office   # Office-supply & stationery stores (monthly)
path_elect <- params$path_elect     # Electronics & appliance stores (monthly)
path_nonstore <- params$path_nonstore            # Nonstore retailers (monthly; e-commerce proxy)

# Company financials (tidy CSVs you generated)
path_odp <- params$path_odp
path_bby <- params$path_bby

focus_start <- as.Date("2022-01-01")
focus_end   <- as.Date("2024-12-31")
```

# 3. Load & Clean Data

```{r}
# Robust FRED reader (DATE / observation_date; auto value col)
read_fred <- function(path, hint=NULL){
  df <- readr::read_csv(path, show_col_types = FALSE)
  date_col <- intersect(names(df), c("observation_date","DATE"))[1]
  if (is.na(date_col)) stop("No date column in: ", path)
  if (!is.null(hint) && hint %in% names(df)) {
    val_col <- hint
  } else if ("VALUE" %in% names(df)) {
    val_col <- "VALUE"
  } else {
    val_col <- setdiff(names(df), date_col)[1]
  }
  tibble(
    Date  = as.Date(lubridate::parse_date_time(df[[date_col]],
              orders = c("Y-m-d","m-d-y","d-m-y","m/d/y","d/m/y","Ymd"))),
    Value = suppressWarnings(as.numeric(df[[val_col]]))
  ) |> arrange(Date)
}

# Monthly → Quarterly average by period-end
to_quarter <- function(df){
  df |>
    dplyr::mutate(Q = lubridate::quarter(Date, with_year = TRUE)) |>
    dplyr::group_by(Q) |>
    dplyr::summarise(Value = mean(Value, na.rm = TRUE), .groups = "drop") |>
    # Use start-of-quarter; avoids lubridate::months()/::days() altogether
    dplyr::mutate(Date = lubridate::yq(Q)) |>
    dplyr::select(Date, Value) |>
    dplyr::arrange(Date)
}


# Detect annual vs monthly/quarterly and compute YoY with correct lag
make_series <- function(path, hint, outname){
  raw <- read_fred(path, hint)

  n_months_unique <- raw |>
    dplyr::mutate(m = lubridate::month(Date)) |>
    dplyr::summarise(n = dplyr::n_distinct(m)) |>
    dplyr::pull(n)

  if (isTRUE(n_months_unique <= 2)) {
    # treat as annual
    agg <- raw |>
      dplyr::mutate(Year = lubridate::year(Date)) |>
      dplyr::group_by(Year) |>
      dplyr::summarise(Value = mean(Value, na.rm = TRUE), .groups = "drop") |>
      dplyr::mutate(Date = lubridate::make_date(Year, 12, 31)) |>
      dplyr::select(Date, Value) |>
      dplyr::arrange(Date)
    lag_n <- 1
  } else {
    agg <- to_quarter(raw)
    lag_n <- 4
  }

  agg <- agg |>
    dplyr::arrange(Date) |>
    dplyr::mutate(YoY = (Value / dplyr::lag(Value, lag_n) - 1))

  names(agg)[names(agg)=="Value"] <- outname
  names(agg)[names(agg)=="YoY"]   <- paste0(outname, "_YoY")
  agg
}
```

```{r}
# Build the three industry series (auto-detects annual vs quarterly)
office_q <- make_series(path_office,   "MRTSSM45321USN", "Office_Sales")
elect_q  <- make_series(path_elect,    "MRTSSM443USS",   "Electronics_Sales")
nonst_q  <- make_series(path_nonstore, "RSNSR",          "Nonstore_Sales")

# Combine & composite YoY
industry_q <- office_q |>
  dplyr::full_join(elect_q,  by = "Date") |>
  dplyr::full_join(nonst_q,  by = "Date") |>
  dplyr::arrange(Date) |>
  dplyr::mutate(
    Innovation_Composite_YoY = rowMeans(
      dplyr::across(c(Electronics_Sales_YoY, Nonstore_Sales_YoY)),
      na.rm = TRUE
    )
  )

#| label: companies
# Company financials (tidy long): ticker, statement, period, date, metric, value
stopifnot(file.exists(path_odp), file.exists(path_bby))
odp_all <- readr::read_csv(path_odp, show_col_types = FALSE) |> mutate(date = as.Date(date))
bby_all <- readr::read_csv(path_bby, show_col_types = FALSE) |> mutate(date = as.Date(date))

mk_q <- function(df, tag){
  rev_q <- df |> filter(statement=="income_statement", period=="quarterly", metric=="Total Revenue") |>
    transmute(Date = as.Date(date), Revenue = as.numeric(value), Company = tag) |>
    arrange(Date) |>
    filter(Date >= as.Date("2021-01-01"), Date <= focus_end) |>
    mutate(Rev_YoY = 100*(Revenue/lag(Revenue,4)-1))

  gp_q  <- df |> filter(statement=="income_statement", period=="quarterly",
                        metric %in% c("Gross Profit","GrossProfit")) |>
    transmute(Date = as.Date(date), GrossProfit = as.numeric(value)) |>
    arrange(Date)

  rev_q |>
    left_join(gp_q, by="Date") |>
    mutate(GMargin = ifelse(!is.na(GrossProfit), 100*(GrossProfit/Revenue), NA_real_)) |>
    arrange(Date)
}

odp_q <- mk_q(odp_all, "ODP")
bby_q <- mk_q(bby_all, "BBY")

cmp_q <- bind_rows(odp_q, bby_q) |>
  filter(Date >= focus_start, Date <= focus_end)
```

# 4. Descriptive Evidence: Legacy vs Innovation Demand

```{r}
# Visualization 1: Category levels (quarterly)
ind_levels <- industry_q |>
  dplyr::filter(Date >= focus_start, Date <= focus_end) |>
  dplyr::select(Date, Office_Sales, Electronics_Sales, Nonstore_Sales) |>
  tidyr::pivot_longer(-Date, names_to="Series", values_to="Value")

ggplot(ind_levels, aes(Date, Value, color = Series)) +
  geom_line(linewidth=1.05, na.rm = TRUE) +
  labs(title = "Industry Demand — Levels (2022–2024)",
       subtitle = "Legacy office-supply sales vs electronics & nonstore retailers",
       x = NULL, y = "Sales (level)", color = NULL)
```

```{r}
# Visualization 2: YoY growth (decimals, formatted as %)
ind_yoy <- industry_q |>
  dplyr::filter(Date >= focus_start, Date <= focus_end) |>
  dplyr::transmute(
    Date,
    Office_YoY   = Office_Sales_YoY,
    Elect_YoY    = Electronics_Sales_YoY,
    Nonstore_YoY = Nonstore_Sales_YoY,
    Innovation_Composite_YoY = Innovation_Composite_YoY
  ) |>
  tidyr::pivot_longer(-Date, names_to="Series", values_to="YoY")

ggplot(ind_yoy, aes(Date, YoY, color = Series)) +
  geom_line(linewidth = 1.05, na.rm = TRUE) +
  geom_hline(yintercept = 0, linetype="dashed") +
  scale_y_continuous(labels = scales::label_percent(accuracy = 0.1)) +
  labs(title = "Industry Demand — YoY Growth (2022–2024)",
       subtitle = "Legacy category stagnates; innovation proxies show stronger momentum",
       x = NULL, y = "YoY Change", color = NULL)
```

**Insight:** **Office_YoY** is flat/negative; **Elect_YoY** and **Nonstore_YoY** are stronger. Growth is in **innovation-aligned** segments — not in ODP’s legacy base.

# 5. Benchmark: ODP vs Best Buy (Innovator Peer)

```{r}
# Visualization 3: Revenue growth YoY — ODP vs BBY
ggplot(cmp_q, aes(Date, Rev_YoY, color = Company)) +
  geom_line(linewidth=1.05) +
  geom_hline(yintercept = 0, linetype="dashed") +
  labs(title = "Revenue Growth YoY — ODP vs BBY (2022–2024)",
       subtitle = "BBY's tech + services orientation supports better top-line resilience",
       x = NULL, y = "YoY Revenue (%)", color = NULL)
```

```{r}
# Visualization 4: Gross Margin — ODP vs BBY
gm_cmp <- cmp_q |> select(Date, Company, GMargin) |> filter(!is.na(GMargin))

ggplot(gm_cmp, aes(Date, GMargin, color = Company)) +
  geom_line(linewidth=1.05) +
  labs(title = "Gross Margin (%) — ODP vs BBY",
       subtitle = "Service-rich, tech-heavy assortments stabilize margins vs commoditized supplies",
       x = NULL, y = "Gross Margin (%)", color = NULL)
```

**Insight:** **BBY** shows **stronger Rev_YoY and margins** than **ODP**, consistent with BBY’s **product + service innovation** (install/support/memberships, hybrid-work assortments) vs ODP’s commodity focus.

# 6. Linking Innovation Demand to ODP Outcomes

```{r}
# Merge ODP with industry innovation measures
link_odp <- odp_q |>
  left_join(industry_q |> select(Date, Office_YoY, Elect_YoY, Nonstore_YoY, Innovation_Composite_YoY),
            by="Date") |>
  filter(Date >= focus_start, Date <= focus_end)

# Visualization 5: ODP Rev_YoY vs Innovation Composite YoY
ggplot(link_odp, aes(Innovation_Composite_YoY, Rev_YoY)) +
  geom_point(size=2, alpha=0.8) +
  geom_smooth(method="lm", se=TRUE) +
  labs(title = "ODP Revenue Growth vs Innovation Demand",
       subtitle = "Positive slope ⇒ ODP grows when innovation segments are stronger (currently under-exposed)",
       x = "Innovation Composite YoY (Electronics & Nonstore avg, %)",
       y = "ODP Revenue YoY (%)")
```

```{r}
# Directional correlations
summ_cor <- link_odp |>
  summarise(
    cor_Rev_Office   = cor(Rev_YoY, Office_YoY,   use="pairwise.complete.obs"),
    cor_Rev_Elect    = cor(Rev_YoY, Elect_YoY,    use="pairwise.complete.obs"),
    cor_Rev_Nonstore = cor(Rev_YoY, Nonstore_YoY, use="pairwise.complete.obs"),
    cor_Rev_Innov    = cor(Rev_YoY, Innovation_Composite_YoY, use="pairwise.complete.obs")
  )
summ_cor
```

**Insight:** Expect **weak/negative** alignment with **Office_YoY**, and **positive** alignment with **Innovation_Composite_YoY** — evidence that **ODP’s results co-move with innovation demand** when present, implying **under-exposure** today.

# 7. What-If Scenario: Innovation Mix-Shift for ODP

```{r}
# Translate correlation into a simple uplift indicator (transparent, conservative)
w_innov <- summ_cor$cor_Rev_Innov %>% tidyr::replace_na(0) %>% pmin(1) %>% pmax(-1)

assumed_lift_pp <- 4   # assume ODP executes initiatives that add ~4pp innovation exposure
predicted_uplift_pp <- as.numeric(w_innov * assumed_lift_pp)

tibble(
  Assumed_Innovation_Exposure_Lift_pp = assumed_lift_pp,
  Weight_from_Historical_Link         = round(w_innov, 2),
  Predicted_RevYoY_Uplift_pp          = round(predicted_uplift_pp, 2)
)
```

**Interpretation:** A modest **+4pp** push toward innovation-aligned segments (hybrid-work tech assortments + service bundles) yields an estimated **Rev YoY uplift** (pp) based on historical co-movement — a clear business case to pivot.

# 8. Recommendations (Product & Service Innovation)

-   **Hybrid-Work Assortment Bundles**: webcams, monitors, docking, routers, ergonomic furniture — packaged for SMB/remote teams.\
-   **Services & Memberships**: onsite/remote setup, device imaging, repair/support tiers, replacement guarantees, **subscription** membership for priority service.\
-   **B2B “Remote Office in a Box”**: monthly package combining devices + furniture + managed print + IT support.\
-   **E-commerce as a Service Platform**: beyond checkout — configure kits, schedule installs, attach services online.\
-   **Dashboard KPIs**: Innovation Mix %, Service Attach Rate, Membership Penetration, Repeat Purchases, SMB Cohort Revenue, AOV, Margin per Cohort.

# 9. Appendix — Diagnostics & Export

```{r}
list(
  industry_rows = nrow(industry_q),
  odp_rows = nrow(odp_q),
  bby_rows = nrow(bby_q),
  cmp_rows = nrow(cmp_q)
)
```

```{r}
head(industry_q); head(odp_q); head(bby_q)
```

```{r}
# Save joined dataset for Shiny if needed
dashboard_df <- cmp_q |>
  left_join(industry_q |> select(Date, Office_YoY, Elect_YoY, Nonstore_YoY, Innovation_Composite_YoY),
            by="Date") |>
  filter(Date >= focus_start, Date <= focus_end)

readr::write_csv(dashboard_df, file.path("output", "dashboard_innovation_join_2022_2024.csv"))
```

```{r}
library(readr); library(dplyr); library(ggplot2); library(lubridate)

# read the tidy “all” file
smwh <- read_csv("data/whsmith/smwh.l_financials_all_tidy_2022_2025.csv")

# Annual revenue & net income
ann <- smwh %>%
  filter(period=="annual", statement=="income_statement",
         metric %in% c("Total Revenue","Net Income","NetIncome","Gross Profit","GrossProfit")) %>%
  mutate(metric = dplyr::recode(metric, "GrossProfit"="Gross Profit", "NetIncome"="Net Income")) %>%
  group_by(metric, date) %>% summarise(value = sum(value, na.rm=TRUE), .groups="drop") %>%
  arrange(date)

# Revenue trend
ann %>% filter(metric=="Total Revenue") %>%
  ggplot(aes(as.Date(date), value/1e9)) +
  geom_line() + geom_point() +
  labs(title="WH Smith — Total Revenue (Annual)", x="Fiscal Year", y="£ billions")

# Gross margin (requires gross profit & revenue present same year)
gm <- ann %>% filter(metric %in% c("Total Revenue","Gross Profit")) %>%
  tidyr::pivot_wider(names_from=metric, values_from=value) %>%
  mutate(GrossMargin = 100 * `Gross Profit` / `Total Revenue`)

ggplot(gm, aes(as.Date(date), GrossMargin)) +
  geom_line() + geom_point() +
  labs(title="WH Smith — Gross Margin (Annual)", x="Fiscal Year", y="%")

# Quarterly liquidity & leverage (from balance sheet)
q_bal <- smwh %>%
  filter(period=="quarterly", statement=="balance_sheet",
         metric %in% c("Cash And Cash Equivalents","CashAndCashEquivalents",
                       "Total Debt","TotalDebt",
                       "Total Current Assets","TotalCurrentAssets",
                       "Total Current Liabilities","TotalCurrentLiabilities")) %>%
  mutate(metric = recode(metric,
         "CashAndCashEquivalents"="Cash And Cash Equivalents",
         "TotalDebt"="Total Debt",
         "TotalCurrentAssets"="Total Current Assets",
         "TotalCurrentLiabilities"="Total Current Liabilities")) %>%
  select(date, metric, value) %>% tidyr::pivot_wider(names_from=metric, values_from=value) %>%
  arrange(date) %>%
  mutate(WorkingCapital = `Total Current Assets` - `Total Current Liabilities`)

# Cash trend
q_bal %>%
  ggplot(aes(as.Date(date), `Cash And Cash Equivalents`/1e6)) +
  geom_line() + geom_point() +
  labs(title="WH Smith — Cash & Equivalents (Quarterly)", x=NULL, y="£ millions")

# Total debt trend
q_bal %>%
  ggplot(aes(as.Date(date), `Total Debt`/1e6)) +
  geom_line() + geom_point() +
  labs(title="WH Smith — Total Debt (Quarterly)", x=NULL, y="£ millions")

# Working capital
q_bal %>%
  ggplot(aes(as.Date(date), WorkingCapital/1e6)) +
  geom_line() + geom_point() +
  labs(title="WH Smith — Working Capital (Quarterly)", x=NULL, y="£ millions")

```
